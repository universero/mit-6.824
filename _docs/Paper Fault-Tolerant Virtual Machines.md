> 论文链接: [The Design of a Practical System for Fault-Tolerant Virtual Machinese](https://pdoasail.mit.edu/6.824/papers/vm-ft.pdf)
___
## 概要

我们实现了一套商业化的企业级系统, 通过从另一台服务器上备份虚拟机的复制主虚拟机的执行的方式提供了具有容错功能的虚拟机. 我们在VMWare vSphere 4.0上设计了一个完整、易用、运行在商品级服务器上并且对于实际应用程序性能损失不超过10%的系统, 此外对于一些实际应用程序, 主VM和备份VM的同步所需的带宽低于20Mbit/s, 这使得更远距离的容错成为可能. 一个简单易用, 能在出错后自动恢复冗余的商用系统需要许多的组件. 我们设计并实现了这些额外的组件并解决了许多在虚拟机上支持企业级应用的实际问题. 本文中我们描述了我们的基础设计, 讨论可选的设计选择和一些实现细节, 并提供小型基准测试和实际应用上的性能表现
## Introduce

实现容错服务器的常见方法是主从复制, 从服务器始终处于待命状态以便在主服务器出现故障时接管工作. 备用服务的状态需要始终和主服务器几乎完全一致, 这样当主服务出错时从服务才能立即接管.. 在这样的方式下, 错误对于其他的客户端是隐藏的且不会有数据丢失. 一种在从服务上复制主服务的方式是将主服务的所有状态持续不断地发送给从服务(包括CPU, 内存和IO设备). 但是发送状态(尤其是内存变化)需要的带宽非常大.

一种不同的复制方法, 状态机方法, 只需要更少的带宽. 其理念是将服务器建模为确定性的状态机, 并确保以相同的初始状态启动, 以相同的顺序接收相同的输入来保持同步. 由于计算机还会有些操作是不确定的, 所以还需要额外的协调来保证主从同步. 然而保持主从同步需要的额外信息远少于主服务中正在变化的量.

实现协调来保证物理服务器的确定性执行是困难的，尤其是在处理器频率不断提高的情况下。相比之下，运行在hypervisor上的虚拟机是实现状态机方法的理想平台。一个 VM 可以被视为一个定义明确的状态机，其操作就是被虚拟化的机器（包括其所有设备）的操作. 与物理服务器一样，VM 也有一些非确定性的操作 (例如读取时钟时间或中断的传递)，因此必须向备份发送额外的信息以确保其保持同步。由于hypervisor完全控制着 VM 的执行，包括所有输入的传递，因此hypervisor能够捕获主 VM 中非确定性操作的所有必要信息，并在备份 VM 上正确地重放这些操作。

因此，可以在商用硬件上实现虚拟机的状态机方法，无需修改硬件，从而能够立即为最新微处理器实现容错功能。此外，状态机方法所需的带宽较低，这使得主服务器和备用服务器之间能够实现更明显的物理隔离。例如，可以将复制的虚拟机运行在分布于校园内的不同物理机上，这比在同一栋楼内运行虚拟机要更可靠。

我们已在 VMware vSphere 4.0 平台上通过主从复制实施了具备容错功能的虚拟机，该平台以高效的方式运行完全虚拟化的 x86 虚拟机。由于 VMware vSphere 实现了完整的 x86 虚拟机，因此我们能够自动为任何 x86 操作系统和应用程序提供容错服务。使我们能够记录主虚拟机的执行过程并确保备份执行完全一致的基础技术被称为确定性回放。VMware vSphere 容错基于确定性回放，但还添加了必要的额外协议和功能，以构建一个完整的容错系统。除了提供硬件容错之外，我们的系统在发生故障后会自动通过在本地集群中的任何可用服务器上启动新的备份虚拟机来恢复冗余。目前确定性回放和 VMware FT 的生产版本仅支持单处理器虚拟机。对多处理器虚拟机的执行过程进行录制和回放的工作仍在进行中，存在严重的性能问题，因为对共享内存的几乎每一次访问都可能是非确定性的操作。

布雷斯多和施奈德描述了一个在PA-RISC平台上的容错VMs原型实现方案. 我们的方法类似, 但是处于性能和设计选项的考虑做了一些根本的修改. 此外, 我们还设计了一些额外的组件来解决构建高效完整系统中遇到的问题和自定义运行企业级应用的系统. 和大多数实际系统的讨论一样, 我们只希望解决错误停机问题(服务器错误可以在造成额外可见的不正确行为前被发现).

论文组织如下: 首先, 描述了基本的设计和确保没有数据丢失的基本协议的细节. 然后描述了构建一个健壮, 完整, 自动的系统过程中解决的许多实际问题. 还讨论了实现容错VMs的不同设计以及它们之间的权衡. 然后给出了实现在一些基准测试和实际企业级应用上的性能表现. 最后说明了相关工作和总结.
## Basic FT Design

下图呈现了我们FT VMs系统的基本组织方式.
![Basic FT Configuration](../../../Basic%20FT%20Configuration.png)
对于一个给定的VM, 我们在另一台不同的物理机上运行backup VM并使其与主VM保持微小之后的同步. 我们称这样的两个VM的状态为virtual lockstep. 两个VM的虚拟磁盘在一个共享内存上(如Fibre Channel或iSCSI磁盘队列). 只有主VM会暴露在网络上, 所有的网络输入和其他输入(如键鼠)都会到主VM上.

所有主VM的接收到的输入会通过被称为logging channel的网络发送到从VM. 对于服务器, 主要的输入是网络和磁盘, 2.1描述的额外信息对于从VM在非确定操作上保持同步是必要的. 此外, 只有主VM的输出会返回给客户端, 从VM的输出会被抛弃. 如2.2描述, 主从VM需要遵从特定的协议(包括确保主VM出错时没有数据丢失的从VM明确的确认)
### 2.1 Deterministic Replay Implementation

不确定性事件和操作会影响VM的状态, 这对复制运行在任意操作系统和机器上的VM的执行带来了如下挑战
- 正确捕获所有的输入和保证确定性执行的不确定性信息
- 正确将所有的输入和不确定性信息应用到从VM
- 在不降低性能的前提下实现这些要求
此外, 许多x86未处理上的复杂操作是没有明确定义的导致了不确定性和副作用. 捕获这些没有定义的副作用和重放他们来产生相同的状态也是额外的挑战

VMware 确定性重放给VMware vSphere平台上的x86系统提供了功能, 它会记录VM的所有输入和可能相关的不确定信息到一个日志流中并写入到日志文件. 然后描述了一系列不确定信息, 这里省略
### 2.2 FT Protocol

在VMware FT中, 我们使用确定性重放产生必要的主VM执行日志, 但并不是写到日志文件中而是通过logging channel发送到从VM. 从VM实时重放这些操作. 日志必须满足严格的FT协议, 最基本的要求如下
- Output Requirement: 如果主VM发送错误, 从VM接管后按照主VM一样的方式继续执行

## Practial Implement of FT
## Design Alternatives
## Others

性能测试, 相关工作均跳过